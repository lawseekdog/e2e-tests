id: rollback
name: 回退补充场景
description: 在文书确认环节发现问题，触发回退补充答辩理由。适用于需要补充证据或理由的场景。

interactions:
  - id: round_1
    name: 初始上诉情况输入
    user_action:
      type: chat
      message: |
        我是被上诉人王五E2E01，对方张三E2E01不服一审判决提起上诉。
        案由：民间借贷纠纷
        一审判决：判决被告张三E2E01返还原告王五E2E01借款本金100000元及利息。
        对方上诉理由：认为借款事实不存在，一审判决认定事实错误。
        我方观点：一审判决认定事实清楚，证据充分，应当维持原判。
      attachments:
        - "{{ assets.first_instance_judgment }}"
        - "{{ assets.appeal_brief }}"
    
    ai_response:
      sse_events:
        - event: skill_start
          expect:
            skill_id: "litigation-intake"
        - event: delta
          expect:
            contains: ["收到", "上诉", "被上诉人"]
        - event: tool_start
          expect:
            tool_name: "knowledge.search"
        - event: tool_end
          expect:
            success: true
        - event: card
          expect:
            review_type: "clarify"
            questions_count: ">= 2"
        - event: end
          expect:
            reason: "card"
      
      final_state:
        type: card
        card:
          review_type: "clarify"
          skill_id: "litigation-intake"
          questions:
            - field_key: "profile.appellee.id_number"
              input_type: "text"
              required: true
            - field_key: "profile.appellant.id_number"
              input_type: "text"
              required: true
      
      thinking:
        must_include: ["上诉", "被上诉人", "一审判决"]
        must_not_include: ["错误", "失败"]

  - id: round_2
    name: 补充当事人身份信息
    user_action:
      type: resume_card
      card_answers:
        - field_key: "profile.appellee.id_number"
          value: "110101199003033456"
        - field_key: "profile.appellant.id_number"
          value: "110101199001011234"
    
    ai_response:
      sse_events:
        - event: skill_start
          expect:
            skill_id: "cause-recommendation"
        - event: delta
          expect:
            contains: ["案由", "民间借贷"]
        - event: tool_start
          expect:
            tool_name: "element__rank_causes"
        - event: tool_end
          expect:
            success: true
        - event: card
          expect:
            review_type: "select"
        - event: end
          expect:
            reason: "card"
      
      final_state:
        type: card
        card:
          review_type: "select"
          skill_id: "cause-recommendation"
          questions:
            - field_key: "profile.cause_of_action_code"
              input_type: "select"
              required: true

  - id: round_3
    name: 确认案由
    user_action:
      type: resume_card
      card_answers:
        - field_key: "profile.cause_of_action_code"
          value: "civil_lending"
    
    ai_response:
      sse_events:
        - event: skill_start
          expect:
            skill_id: "litigation-intake"
        - event: delta
          expect:
            contains: ["答辩策略", "维持原判"]
        - event: card
          expect:
            review_type: "select"
        - event: end
          expect:
            reason: "card"
      
      final_state:
        type: card
        card:
          review_type: "select"
          skill_id: "litigation-intake"
          questions:
            - field_key: "profile.decisions.defense_strategy"
              input_type: "select"
              required: true

  - id: round_4
    name: 选择答辩策略
    user_action:
      type: resume_card
      card_answers:
        - field_key: "profile.decisions.defense_strategy"
          value: "maintain_original_judgment"
    
    ai_response:
      sse_events:
        - event: skill_start
          expect:
            skill_id: "documents"
        - event: delta
          expect:
            contains: ["文书", "答辩状"]
        - event: card
          expect:
            review_type: "select"
        - event: end
          expect:
            reason: "card"
      
      final_state:
        type: card
        card:
          review_type: "select"
          skill_id: "documents"
          questions:
            - field_key: "profile.decisions.selected_documents"
              input_type: "multi_select"
              required: true

  - id: round_5
    name: 选择文书类型
    user_action:
      type: resume_card
      card_answers:
        - field_key: "profile.decisions.selected_documents"
          value: ["appeal_defense"]
    
    ai_response:
      sse_events:
        - event: skill_start
          expect:
            skill_id: "document-generation"
        - event: tool_start
          expect:
            tool_name: "template__render_batch_to_files"
        - event: tool_end
          expect:
            success: true
            result:
              has_file_id: true
        - event: card
          expect:
            review_type: "confirm"
        - event: end
          expect:
            reason: "card"
      
      final_state:
        type: card
        card:
          review_type: "confirm"
          skill_id: "document-generation"
          questions:
            - field_key: "profile.decisions.document_reviewed"
              input_type: "document_review"
              required: true

  - id: round_6
    name: 发现问题触发补充
    user_action:
      type: resume_card
      card_answers:
        - field_key: "profile.decisions.document_reviewed"
          value: false
          feedback: "答辩理由需要补充，对方质疑借款真实性，需要更详细的证据说明。"
    
    ai_response:
      sse_events:
        - event: skill_start
          expect:
            skill_id: "litigation-intake"
        - event: delta
          expect:
            contains: ["补充", "答辩理由", "证据"]
        - event: card
          expect:
            review_type: "clarify"
        - event: end
          expect:
            reason: "card"
      
      final_state:
        type: card
        card:
          review_type: "clarify"
          skill_id: "litigation-intake"
          questions:
            - field_key: "profile.defense_grounds_detail"
              input_type: "textarea"
              required: true
            - field_key: "profile.additional_evidence"
              input_type: "file_upload"
              required: false

  - id: round_7
    name: 补充答辩理由和证据
    user_action:
      type: resume_card
      card_answers:
        - field_key: "profile.defense_grounds_detail"
          value: "一审判决认定事实清楚，证据充分。借款事实有借条、转账记录、聊天记录等多项证据相互印证。借条系被告亲笔书写并签字确认，转账记录显示原告于2023年1月1日通过银行转账方式向被告支付借款100000元，聊天记录显示被告多次承认借款事实并承诺还款。上述证据形成完整证据链，足以证明借款事实存在。"
      attachments:
        - "{{ assets.defense_grounds }}"
        - "{{ assets.additional_evidence }}"
    
    ai_response:
      sse_events:
        - event: skill_start
          expect:
            skill_id: "document-generation"
        - event: tool_start
          expect:
            tool_name: "template__render_batch_to_files"
        - event: tool_end
          expect:
            success: true
            result:
              has_file_id: true
        - event: card
          expect:
            review_type: "confirm"
        - event: end
          expect:
            reason: "card"
      
      final_state:
        type: card
        card:
          review_type: "confirm"
          skill_id: "document-generation"
          questions:
            - field_key: "profile.decisions.document_reviewed"
              input_type: "document_review"
              required: true

  - id: round_8
    name: 确认最终文书
    user_action:
      type: resume_card
      card_answers:
        - field_key: "profile.decisions.document_reviewed"
          value: true
    
    ai_response:
      sse_events:
        - event: skill_start
          expect:
            skill_id: "document-generation"
        - event: delta
          expect:
            contains: ["答辩状", "生成", "完成"]
        - event: end
          expect:
            reason: "stop"
      
      final_state:
        type: message
        message:
          contains: ["答辩状", "生成", "下载"]
          length: ">= 100"
        deliverable:
          output_key: "appeal_defense"
          file_type: "docx"

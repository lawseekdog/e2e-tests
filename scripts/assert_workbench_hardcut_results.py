#!/usr/bin/env python3
from __future__ import annotations

import argparse
import json
from pathlib import Path
from typing import Any


def load_json(path: Path) -> dict[str, Any]:
    if not path.exists():
        return {}
    try:
        return json.loads(path.read_text(encoding='utf-8'))
    except Exception:
        return {}


def has_value(raw: object) -> bool:
    s = str(raw or '').strip()
    if not s:
        return False
    lowered = s.lower()
    return lowered not in {'-', '—', 'none', 'null', 'n/a'}


def contains_any(text: str, tokens: list[str]) -> bool:
    return any(token in text for token in tokens)


def detect_legacy_contract(*states: dict[str, Any]) -> bool:
    for state in states:
        if not isinstance(state, dict) or not state:
            continue
        if bool(state.get('legacy_contract_detected')):
            return True
        preview = str(state.get('body_preview') or '')
        if contains_any(preview, ['推荐度', '证据支撑度', '待确认卡片']):
            return True
    return False


def build_check(check_id: str, title: str, passed: bool, detail: str, *, blocked: bool = False) -> dict[str, Any]:
    status = 'blocked' if blocked else ('pass' if bool(passed) else 'fail')
    return {
        'id': check_id,
        'title': title,
        'status': status,
        'passed': bool(passed) if not blocked else False,
        'blocked': bool(blocked),
        'detail': detail,
    }


def main() -> int:
    parser = argparse.ArgumentParser(description='Assert hardcut workbench Playwright artifacts')
    parser.add_argument('--artifacts', required=True, help='Artifacts root generated by run_workbench_hardcut_playwright_cli.sh')
    args = parser.parse_args()

    artifacts = Path(args.artifacts).resolve()
    json_dir = artifacts / 'json'

    state_overview = load_json(json_dir / 'state_overview.json')
    state_analysis = load_json(json_dir / 'state_analysis.json')
    state_cause_detail = load_json(json_dir / 'state_cause_detail.json')
    state_citation_trace = load_json(json_dir / 'state_citation_trace.json')
    state_pre_upload = load_json(json_dir / 'state_pre_upload.json')
    state_post_upload = load_json(json_dir / 'state_post_upload.json')
    upload_state = load_json(json_dir / 'step-06-upload-evidence.json')
    upload_prompt_state = load_json(json_dir / 'step-07-upload-prompt.json')
    recompute_compare = load_json(json_dir / 'recompute_compare.json')
    ws_state = load_json(json_dir / 'state_ws_stability.json')
    isolation_state = load_json(json_dir / 'state_isolation.json')

    legacy_contract = detect_legacy_contract(state_overview, state_analysis)
    legacy_blocked_ids = {
        'P0-01',
        'P0-02',
        'P0-03',
        'P0-04',
        'P0-05',
        'P0-06',
        'P0-07',
        'P0-08',
        'P0-10',
    }

    checks: list[dict[str, Any]] = []

    def append_check(check_id: str, title: str, passed: bool, detail: str) -> None:
        blocked = legacy_contract and check_id in legacy_blocked_ids
        if blocked:
            detail += ' | BLOCKED: 检测到环境仍为 legacy 合同（含推荐度/旧卡片），硬切字段未生效。'
        checks.append(build_check(check_id, title, passed, detail, blocked=blocked))

    basics = state_overview.get('basics') or {}
    missing_basics = [
        field
        for field in ('service_type', 'procedure_stage', 'plaintiff', 'defendant')
        if not has_value(basics.get(field))
    ]
    append_check(
        'P0-01',
        '基础信息显示',
        bool(basics.get('visible')) and not missing_basics,
        f"visible={bool(basics.get('visible'))}, missing={missing_basics}",
    )

    cause = state_overview.get('cause') or {}
    cause_count_ok = int(cause.get('count') or 0) == 5
    confirmed_count = int(cause.get('confirmed_count') or 0)
    pin_ok = True if confirmed_count == 0 else bool(cause.get('first_is_confirmed'))
    append_check(
        'P0-02',
        '候选案由列表',
        cause_count_ok and pin_ok,
        f"count={cause.get('count')}, confirmed_count={confirmed_count}, first_is_confirmed={cause.get('first_is_confirmed')}",
    )

    detail_ok = all(
        bool(state_cause_detail.get(k))
        for k in (
            'visible',
            'has_reason',
            'has_supporting_facts',
            'has_supporting_evidence',
            'has_missing_materials',
            'has_risk_flags',
            'has_counter_reasons',
        )
    )
    append_check('P0-03', '候选案由详情弹窗', detail_ok, json.dumps(state_cause_detail, ensure_ascii=False))

    analysis_refs = state_analysis.get('references') or {}
    legal_count = int(analysis_refs.get('legal_count') or 0)
    if legal_count > 0:
        legal_ok = bool(analysis_refs.get('legal_first_has_article')) and bool(analysis_refs.get('legal_first_has_reason'))
    else:
        legal_ok = contains_any(str(analysis_refs.get('legal_empty_reason') or ''), ['案由未确认', '证据不足', '检索无命中', '暂无'])
    append_check(
        'P0-04',
        '法条展示',
        legal_ok,
        f"legal_count={legal_count}, empty_reason={analysis_refs.get('legal_empty_reason')}",
    )

    case_count = int(analysis_refs.get('case_count') or 0)
    if case_count > 0:
        case_ok = bool(analysis_refs.get('case_first_has_case_no')) and bool(analysis_refs.get('case_first_has_similarity'))
    else:
        case_ok = contains_any(str(analysis_refs.get('case_empty_reason') or ''), ['案由未确认', '证据不足', '检索无命中', '暂无'])
    append_check(
        'P0-05',
        '类案展示',
        case_ok,
        f"case_count={case_count}, empty_reason={analysis_refs.get('case_empty_reason')}",
    )

    uploaded = bool(upload_state.get('uploaded'))
    prompt_sent = bool(upload_prompt_state.get('sent'))
    changed = bool(((recompute_compare.get('changed') or {}).get('any_changed')))
    append_check(
        'P0-06',
        '上传后自动重算',
        uploaded and prompt_sent and changed,
        f'uploaded={uploaded}, prompt_sent={prompt_sent}, changed={changed}',
    )

    cause_status = str((state_overview.get('basics') or {}).get('status') or '')
    strategy_locked = bool((state_overview.get('strategy') or {}).get('locked'))
    if '已确认' in cause_status:
        lock_rule_ok = not strategy_locked
    else:
        lock_rule_ok = strategy_locked
    append_check(
        'P0-07',
        '案由未确认锁定策略/预测',
        lock_rule_ok,
        f'cause_status={cause_status}, strategy_locked={strategy_locked}',
    )

    citation_cards = int(state_citation_trace.get('citation_cards') or 0)
    citation_ok = bool(state_citation_trace.get('clicked')) and citation_cards > 0
    append_check(
        'P0-08',
        '引用回溯',
        citation_ok,
        f"clicked={state_citation_trace.get('clicked')}, citation_cards={citation_cards}",
    )

    ws_ok = (
        '_parse_error' not in ws_state
        and bool(ws_state.get('toggled'))
        and int(ws_state.get('blank_message_count') or 0) == 0
        and int(ws_state.get('consecutive_duplicates') or 0) == 0
    )
    append_check('P0-09', 'WS 稳定性', ws_ok, json.dumps(ws_state, ensure_ascii=False))

    isolation_ok = (
        '_parse_error' not in isolation_state
        and not bool(isolation_state.get('skipped'))
        and not bool(isolation_state.get('leaked'))
        and not bool(isolation_state.get('has_basics'))
    )
    append_check('P0-10', '信息隔离', isolation_ok, json.dumps(isolation_state, ensure_ascii=False))

    passed = [c for c in checks if c['status'] == 'pass']
    blocked = [c for c in checks if c['status'] == 'blocked']
    failed = [c for c in checks if c['status'] == 'fail']

    report = {
        'artifact_root': str(artifacts),
        'legacy_contract_detected': legacy_contract,
        'total': len(checks),
        'passed': len(passed),
        'blocked': len(blocked),
        'failed': len(failed),
        'checks': checks,
        'state_files': {
            'overview': bool(state_overview),
            'analysis': bool(state_analysis),
            'pre_upload': bool(state_pre_upload),
            'post_upload': bool(state_post_upload),
        },
    }

    (artifacts / 'assert_report.json').write_text(json.dumps(report, ensure_ascii=False, indent=2), encoding='utf-8')

    md_lines = [
        '# Workbench Hardcut Playwright Assertion Report',
        '',
        f'- Artifacts: `{artifacts}`',
        f'- Passed: **{len(passed)}/{len(checks)}**',
        f'- Blocked: **{len(blocked)}**',
        f'- Failed: **{len(failed)}**',
        f"- Legacy contract detected: **{'YES' if legacy_contract else 'NO'}**",
        '',
        '## Checks',
    ]
    for c in checks:
        marker = 'PASS' if c['status'] == 'pass' else ('BLOCKED' if c['status'] == 'blocked' else 'FAIL')
        md_lines.append(f"- [{marker}] {c['id']} {c['title']} — {c['detail']}")
    (artifacts / 'assert_report.md').write_text('\n'.join(md_lines) + '\n', encoding='utf-8')

    for c in checks:
        marker = 'PASS' if c['status'] == 'pass' else ('BLOCKED' if c['status'] == 'blocked' else 'FAIL')
        print(f"[{marker}] {c['id']} {c['title']}: {c['detail']}")

    print(f"\nSummary: pass={len(passed)}, blocked={len(blocked)}, fail={len(failed)}, total={len(checks)}")
    print(f"Report JSON: {artifacts / 'assert_report.json'}")
    print(f"Report MD: {artifacts / 'assert_report.md'}")

    return 0 if not failed else 1


if __name__ == '__main__':
    raise SystemExit(main())

version: "1.0"

steps:
  - id: browser_step_1
    name: 导航到系统首页
    tool: mcp_chrome-devtools_navigate_page
    params:
      url: "{{ config.base_url }}"
    expect:
      wait_for_text: "登录"
    on_failure: abort

  - id: browser_step_2
    name: 获取页面快照定位登录表单
    tool: mcp_chrome-devtools_take_snapshot
    expect:
      contains_elements:
        - role: textbox
        - role: button

  - id: browser_step_3
    name: 填写登录表单
    tool: mcp_chrome-devtools_fill_form
    params:
      elements:
        - uid: "{{ browser_step_2.result.username_input_uid }}"
          value: "{{ credentials.username }}"
        - uid: "{{ browser_step_2.result.password_input_uid }}"
          value: "{{ credentials.password }}"
    on_failure: retry
    retry:
      max_attempts: 2
      delay_ms: 1000

  - id: browser_step_4
    name: 点击登录按钮
    tool: mcp_chrome-devtools_click
    params:
      uid: "{{ browser_step_2.result.login_button_uid }}"
    expect:
      wait_for_text: "工作台"
    on_failure: abort

  - id: browser_step_5
    name: 获取工作台快照
    tool: mcp_chrome-devtools_take_snapshot
    expect:
      contains_elements:
        - text: "新建"

  - id: browser_step_6
    name: 点击新建按钮创建会话
    tool: mcp_chrome-devtools_click
    params:
      uid: "{{ browser_step_5.result.new_button_uid }}"
    expect:
      wait_for_text: "输入"
    on_failure: abort

  - id: browser_step_7
    name: 获取会话页面快照
    tool: mcp_chrome-devtools_take_snapshot

  - id: browser_step_8
    name: 上传文件
    tool: mcp_chrome-devtools_upload_file
    params:
      uid: "{{ browser_step_7.result.file_input_uid }}"
      filePath: "{{ current_path.current_round.user_action.file }}"
    on_failure: retry
    retry:
      max_attempts: 2
      delay_ms: 1000

  - id: browser_step_9
    name: 填写用户消息
    tool: mcp_chrome-devtools_fill
    params:
      uid: "{{ browser_step_7.result.input_textarea_uid }}"
      value: "{{ current_path.current_round.user_action.message }}"

  - id: browser_step_10
    name: 发送消息
    tool: mcp_chrome-devtools_click
    params:
      uid: "{{ browser_step_7.result.send_button_uid }}"
    on_failure: abort

  - id: browser_step_11
    name: 等待 AI 响应
    tool: mcp_chrome-devtools_wait_for
    params:
      text: "{{ current_path.current_round.ai_response.wait_for_text }}"
      timeout: 90000
    on_failure: abort

  - id: browser_step_12
    name: 获取响应快照
    tool: mcp_chrome-devtools_take_snapshot
    expect:
      contains_text: "{{ current_path.current_round.ai_response.expect_contains }}"

  - id: browser_step_13
    name: 处理卡片交互
    tool: mcp_chrome-devtools_click
    params:
      uid: "{{ browser_step_12.result.card_action_button_uid }}"
    condition: "{{ current_path.current_round.has_card_interaction }}"
    on_failure: retry
    retry:
      max_attempts: 2
      delay_ms: 1000

  - id: browser_step_14
    name: 截图保存验证结果
    tool: mcp_chrome-devtools_take_screenshot
    params:
      filePath: docs/verification.png
    condition: "{{ current_path.is_final_round }}"
    on_failure: continue

id: rollback
name: 回退补充证据
description: 中途补充证据文件，触发回退重新分析。适用于测试回退逻辑的场景。

interactions:
  - id: round_1
    name: 初始案情输入
    user_action:
      type: chat
      message: |
        原告：张三E2E01
        被告：李四E2E01
        案由：民间借贷纠纷
        事实：2023年1月1日，被告向原告借款人民币100000元，约定2023年12月31日前归还。
        原告已通过银行转账交付借款，被告出具借条。到期后被告未还，原告多次催收无果。
        证据：借条、转账记录、聊天记录
        诉求：返还本金100000元，并按年利率6%支付逾期利息，承担诉讼费。
      attachments:
        - "{{ assets.iou }}"
        - "{{ assets.transfer_record }}"
        - "{{ assets.chat_record }}"
    
    ai_response:
      sse_events:
        - event: skill_start
          expect:
            skill_id: "litigation-intake"
        - event: delta
          expect:
            contains: ["收到", "案件", "民间借贷"]
        - event: card
          expect:
            review_type: "clarify"
            questions_count: ">= 2"
        - event: end
          expect:
            reason: "card"
      
      final_state:
        type: card
        card:
          review_type: "clarify"
          skill_id: "litigation-intake"
          questions:
            - field_key: "profile.plaintiff.id_number"
              input_type: "text"
              required: true
            - field_key: "profile.defendant.id_number"
              input_type: "text"
              required: true

  - id: round_2
    name: 补充当事人身份信息
    user_action:
      type: resume_card
      card_answers:
        - field_key: "profile.plaintiff.id_number"
          value: "110101199001011234"
        - field_key: "profile.defendant.id_number"
          value: "110101199002022345"
    
    ai_response:
      sse_events:
        - event: skill_start
          expect:
            skill_id: "cause-recommendation"
        - event: card
          expect:
            review_type: "select"
        - event: end
          expect:
            reason: "card"
      
      final_state:
        type: card
        card:
          review_type: "select"
          skill_id: "cause-recommendation"

  - id: round_3
    name: 确认案由
    user_action:
      type: resume_card
      card_answers:
        - field_key: "profile.cause_of_action_code"
          value: "civil_lending"
    
    ai_response:
      sse_events:
        - event: skill_start
          expect:
            skill_id: "documents"
        - event: card
          expect:
            review_type: "select"
        - event: end
          expect:
            reason: "card"
      
      final_state:
        type: card
        card:
          review_type: "select"
          skill_id: "documents"

  - id: round_4
    name: 选择文书类型
    user_action:
      type: resume_card
      card_answers:
        - field_key: "profile.decisions.selected_documents"
          value: ["civil_complaint"]
    
    ai_response:
      sse_events:
        - event: skill_start
          expect:
            skill_id: "document-generation"
        - event: card
          expect:
            review_type: "confirm"
        - event: end
          expect:
            reason: "card"
      
      final_state:
        type: card
        card:
          review_type: "confirm"
          skill_id: "document-generation"

  - id: round_5
    name: 补充新证据（触发回退）
    user_action:
      type: upload_file
      message: |
        我找到了一份新的证据：被告的还款承诺书，请重新分析。
      attachments:
        - "{{ assets.additional_evidence }}"
    
    ai_response:
      sse_events:
        - event: skill_start
          expect:
            skill_id: "evidence-file-analysis"
        - event: delta
          expect:
            contains: ["新证据", "分析"]
        - event: phase_rollback
          expect:
            from_phase: "finalize"
            to_phase: "analyze"
        - event: skill_start
          expect:
            skill_id: "evidence-analysis"
        - event: end
          expect:
            reason: "stop"
      
      final_state:
        type: message
        message:
          contains: ["新证据", "还款承诺", "重新分析"]
          length: ">= 100"
      
      thinking:
        must_include: ["新证据", "回退", "重新分析"]

  - id: round_6
    name: 重新确认案由（如需要）
    user_action:
      type: chat
      message: "请继续生成起诉状"
    
    ai_response:
      sse_events:
        - event: skill_start
          expect:
            skill_id: "documents"
        - event: card
          expect:
            review_type: "select"
        - event: end
          expect:
            reason: "card"
      
      final_state:
        type: card
        card:
          review_type: "select"
          skill_id: "documents"

  - id: round_7
    name: 重新选择文书类型
    user_action:
      type: resume_card
      card_answers:
        - field_key: "profile.decisions.selected_documents"
          value: ["civil_complaint"]
    
    ai_response:
      sse_events:
        - event: skill_start
          expect:
            skill_id: "document-generation"
        - event: tool_start
          expect:
            tool_name: "template__render_batch_to_files"
        - event: tool_end
          expect:
            success: true
        - event: card
          expect:
            review_type: "confirm"
        - event: end
          expect:
            reason: "card"
      
      final_state:
        type: card
        card:
          review_type: "confirm"
          skill_id: "document-generation"

  - id: round_8
    name: 确认文书
    user_action:
      type: resume_card
      card_answers:
        - field_key: "profile.decisions.document_reviewed"
          value: true
    
    ai_response:
      sse_events:
        - event: delta
          expect:
            contains: ["起诉状", "生成", "完成"]
        - event: end
          expect:
            reason: "stop"
      
      final_state:
        type: message
        message:
          contains: ["起诉状", "生成", "下载", "还款承诺"]
          length: ">= 100"
        deliverable:
          output_key: "civil_complaint"
          file_type: "docx"
